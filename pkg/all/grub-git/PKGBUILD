#
_UNIFONT_VER="6.3.20131217"
_EFI_ARCH="arm64"

pkgname="grub-git"
pkgdesc="GNU GRand Unified Bootloader (2)"
pkgver=2.02.beta3.16.gb524fa2
pkgrel=1
url="https://www.gnu.org/software/grub/"
arch=('aarch64')
license=('GPL3')
backup=('boot/grub/grub.cfg' 'etc/default/grub' 'etc/grub.d/40_custom')
install="grub.install"
options=('!makeflags')

makedepends=('git' 'rsync' 'xz' 'freetype2' 'ttf-dejavu' 'python' 'autogen'
             'texinfo' 'help2man' 'gettext' 'device-mapper' 'fuse')
depends=('sh' 'xz' 'gettext' 'device-mapper' 'efibootmgr')
optdepends=('freetype2: For grub-mkfont usage'
            'fuse: For grub-mount usage'
            'dosfstools: For grub-mkrescue FAT FS and EFI support'
            'libisoburn: Provides xorriso for generating grub rescue iso using grub-mkrescue'
            'os-prober: To detect other OSes when generating grub.cfg in BIOS systems'
            'mtools: For grub-mkrescue FAT FS support')

source=("git://git.sv.gnu.org/grub.git"
        "git://git.sv.gnu.org/grub-extras.git"
        "http://ftp.gnu.org/gnu/unifont/unifont-${_UNIFONT_VER}/unifont-${_UNIFONT_VER}.bdf.gz"
        'grub-10_linux-detect-archlinux-initramfs.patch'
        'grub-add-GRUB_COLOR_variables.patch'
        'grub.default'
        'grub.cfg')

md5sums=('SKIP'
         'SKIP'
         '728b7439ac733a7c0d56049adec364c7'
         '945527e0de8d384166a4cf23439ae9ee'
         'e506ae4a9f9f7d1b765febfa84e10d48'
         'a03ffd56324520393bf574cefccb893d'
         'c8b9511586d57d6f2524ae7898397a46')

pkgver() {
  cd grub
  echo "$(git describe --tags)" | sed -e 's|grub.||g' -e 's|-|\.|g'
}

prepare() {
  cd grub

  msg "Patch to detect of Arch Linux initramfs images by grub-mkconfig"
  patch -Np1 -i ../grub-10_linux-detect-archlinux-initramfs.patch
  echo

  msg "Patch to enable GRUB_COLOR_* variables in grub-mkconfig"
  ## Based on http://lists.gnu.org/archive/html/grub-devel/2012-02/msg00021.html
  patch -Np1 -i ../grub-add-GRUB_COLOR_variables.patch
  echo

  msg "Fix DejaVuSans.ttf location so that grub-mkfont can create *.pf2 files for starfield theme"
  sed 's|/usr/share/fonts/dejavu|/usr/share/fonts/dejavu /usr/share/fonts/TTF|g' -i configure.ac

  msg "Fix mkinitcpio 'rw' FS#36275"
  sed 's| ro | rw |g' -i util/grub.d/10_linux.in

  msg "Fix OS naming FS#33393"
  sed 's|GNU/Linux|Linux|' -i util/grub.d/10_linux.in

  msg "Pull in latest language files"
  ./linguas.sh
  echo

  msg "Remove not working langs which need LC_ALL=C.UTF-8"
  sed -e 's#en@cyrillic en@greek##g' -i po/LINGUAS

  msg "Avoid problem with unifont during compile of grub, http://savannah.gnu.org/bugs/?40330 and https://bugs.archlinux.org/task/37847"
  cp ../unifont-${_UNIFONT_VER}.bdf unifont.bdf
}

build() {
  cd grub

  msg "Add the grub-extra sources"
  install -d grub-extras
  cp -r ../grub-extras/915resolution grub-extras/915resolution
  export GRUB_CONTRIB="${srcdir}/grub/grub-extras/"

  msg "Unset all compiler FLAGS"
  unset CFLAGS
  unset CPPFLAGS
  unset CXXFLAGS
  unset LDFLAGS
  unset MAKEFLAGS

  msg "Run autogen.sh"
  ./autogen.sh
  echo

  msg "Run ./configure"
  ./configure \
      --enable-mm-debug \
      --enable-nls \
      --enable-device-mapper \
      --enable-cache-stats \
      --enable-boot-time \
      --enable-grub-mkfont \
      --enable-grub-mount \
      --prefix="/usr" \
      --bindir="/usr/bin" \
      --sbindir="/usr/bin" \
      --mandir="/usr/share/man" \
      --infodir="/usr/share/info" \
      --datarootdir="/usr/share" \
      --sysconfdir="/etc" \
      --program-prefix="" \
      --with-bootdir="/boot" \
      --with-grubdir="grub" \
      --disable-silent-rules \
      --disable-werror
  echo

  msg "Run make"
  make
}

package() {
  cd grub

  msg "Run make install"
  make DESTDIR="${pkgdir}/" \
       bashcompletiondir="/usr/share/bash-completion/completions" install
  echo

  msg "Install /etc/default/grub (used by grub-mkconfig)"
  install -D -m0644 ../grub.default "${pkgdir}/etc/default/grub"

  msg "Install grub.cfg for backup array"
  install -D -m0644 ../grub.cfg "${pkgdir}/boot/grub/grub.cfg"
}
