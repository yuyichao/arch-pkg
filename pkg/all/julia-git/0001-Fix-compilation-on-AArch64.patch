From 45d08d6764dc8e9ae2ee9fcba8c6f785474c8ba9 Mon Sep 17 00:00:00 2001
From: Yichao Yu <yyc1992@gmail.com>
Date: Tue, 29 Dec 2015 01:32:14 -0500
Subject: [PATCH] Fix compilation on AArch64

---
 src/disasm.cpp         |  2 +-
 src/ia_misc.h          | 24 +++++++++++++++++++++++-
 src/support/platform.h |  2 ++
 3 files changed, 26 insertions(+), 2 deletions(-)

diff --git a/src/disasm.cpp b/src/disasm.cpp
index 667c9c5..cdcd976 100644
--- a/src/disasm.cpp
+++ b/src/disasm.cpp
@@ -583,7 +583,7 @@ void jl_dump_asm_internal(uintptr_t Fptr, size_t Fsize, size_t slide,
             switch (S) {
             case MCDisassembler::Fail:
                 if (insSize == 0) // skip illegible bytes
-#if defined(_CPU_PPC_) || defined(_CPU_PPC64_) || defined(_CPU_ARM_)
+#if defined(_CPU_PPC_) || defined(_CPU_PPC64_) || defined(_CPU_ARM_) || defined(_CPU_AARCH64_)
                     insSize = 4; // instructions are always 4 bytes
 #else
                     insSize = 1; // attempt to slide 1 byte forward
diff --git a/src/ia_misc.h b/src/ia_misc.h
index c6aac9b..67c0076 100644
--- a/src/ia_misc.h
+++ b/src/ia_misc.h
@@ -94,7 +94,29 @@ STATIC_INLINE void cpu_lfence(void)
     _mm_lfence();
 }
 
-#elif defined(__ARM_ARCH) && __ARM_ARCH >= 7
+#elif defined(_CPU_AARCH64_)
+
+STATIC_INLINE void cpu_pause(void)
+{
+    __asm__ volatile ("wfe" ::: "memory");
+}
+
+STATIC_INLINE void cpu_mfence(void)
+{
+    __asm__ volatile ("dmb ish" ::: "memory");
+}
+
+STATIC_INLINE void cpu_sfence(void)
+{
+    __asm__ volatile ("dmb ishst" ::: "memory");
+}
+
+STATIC_INLINE void cpu_lfence(void)
+{
+    __asm__ volatile ("dmb ishld" ::: "memory");
+}
+
+#elif defined(_CPU_ARM_) && __ARM_ARCH >= 7
 
 STATIC_INLINE void cpu_pause(void)
 {
diff --git a/src/support/platform.h b/src/support/platform.h
index ac2ac8d..c0e9534 100644
--- a/src/support/platform.h
+++ b/src/support/platform.h
@@ -81,6 +81,8 @@
 #define _CPU_X86_64_
 #elif defined(i386) || defined(__i386) || defined(__i386__) || defined(_M_IX86) || defined(_X86_)
 #define _CPU_X86_
+#elif defined(__aarch64__)
+#define _CPU_AARCH64_
 #elif defined(__arm__) || defined(_M_ARM)
 #define _CPU_ARM_
 #elif defined(__PPC64__)
-- 
2.6.4

