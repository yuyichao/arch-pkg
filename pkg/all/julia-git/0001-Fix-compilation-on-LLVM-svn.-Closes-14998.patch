From 784bd7bb7f76da0d9a03e50d13cf39a10a8b4936 Mon Sep 17 00:00:00 2001
From: Yichao Yu <yyc1992@gmail.com>
Date: Mon, 14 Mar 2016 06:11:55 +0000
Subject: [PATCH] Fix compilation on LLVM svn. Closes #14998

---
 src/codegen.cpp   | 3 +++
 src/jitlayers.cpp | 6 +++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/src/codegen.cpp b/src/codegen.cpp
index 620490d..4b04840 100644
--- a/src/codegen.cpp
+++ b/src/codegen.cpp
@@ -68,6 +68,9 @@
 #include <llvm/Transforms/Utils/BasicBlockUtils.h>
 #include <llvm/Transforms/Instrumentation.h>
 #include <llvm/Transforms/Vectorize.h>
+#ifdef LLVM39
+#include <llvm/Transforms/Scalar/GVN.h>
+#endif
 #include <llvm/Support/Host.h>
 #include <llvm/Support/TargetSelect.h>
 #include <llvm/Support/raw_ostream.h>
diff --git a/src/jitlayers.cpp b/src/jitlayers.cpp
index 42331e0..78a56b3 100644
--- a/src/jitlayers.cpp
+++ b/src/jitlayers.cpp
@@ -102,8 +102,12 @@ static void addOptimizationPasses(T *PM)
     PM->add(createJumpThreadingPass());         // Thread jumps
     PM->add(createDeadStoreEliminationPass());  // Delete dead stores
 #if !defined(INSTCOMBINE_BUG)
-    if (jl_options.opt_level >= 3)
+    if (jl_options.opt_level >= 3) {
+#ifdef LLVM39
+        initializeDemandedBitsPass(*PassRegistry::getPassRegistry());
+#endif
         PM->add(createSLPVectorizerPass());     // Vectorize straight-line code
+    }
 #endif
 
     PM->add(createAggressiveDCEPass());         // Delete dead instructions
-- 
2.7.3

